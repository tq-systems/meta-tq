From 729bfeb8bbf3c5b0a6fc478f78fd29e79fac047d Mon Sep 17 00:00:00 2001
From: Andreas Dumberger <andreas.dumberger@tq-group.com>
Date: Tue, 16 Feb 2021 16:04:34 +0100
Subject: [PATCH] add TQMaRZG2x modules

Signed-off-by: Andreas Dumberger <andreas.dumberger@tq-group.com>
---
 drivers/renesas/rzg/board/board.c             |  21 ++
 drivers/renesas/rzg/board/board.h             |   5 +-
 .../rzg/ddr/ddr_b/boot_init_dram_config.c     | 201 +++++++++++++++++-
 plat/renesas/rzg/bl2_plat_setup.c             |  26 ++-
 plat/renesas/rzg/platform.mk                  |  18 ++
 5 files changed, 267 insertions(+), 4 deletions(-)

diff --git a/drivers/renesas/rzg/board/board.c b/drivers/renesas/rzg/board/board.c
index b2f274821..4366be64f 100644
--- a/drivers/renesas/rzg/board/board.c
+++ b/drivers/renesas/rzg/board/board.c
@@ -19,13 +19,25 @@
 #if (RCAR_LSI == RCAR_E3)
 #define BOARD_DEFAULT		(BOARD_EK874 << BOARD_CODE_SHIFT)
 #elif (RCAR_LSI == RCAR_M3N)
+#if (RZG_TQMARZG2N_B)
+#define BOARD_DEFAULT		(BOARD_TQMARZG2N_B << BOARD_CODE_SHIFT)
+#else
 #define BOARD_DEFAULT		(BOARD_HIHOPE_RZG2N << BOARD_CODE_SHIFT)
+#endif
 #elif (RCAR_LSI == RCAR_H3N)
+#if (RZG_TQMARZG2H_C)
+#define BOARD_DEFAULT		(BOARD_TQMARZG2H_C << BOARD_CODE_SHIFT)
+#else
 #define BOARD_DEFAULT		(BOARD_HIHOPE_RZG2H << BOARD_CODE_SHIFT)
+#endif
+#else
+#if (RZG_TQMARZG2M_E)
+#define BOARD_DEFAULT		(BOARD_TQMARZG2M_E << BOARD_CODE_SHIFT)
 #else
 #define BOARD_DEFAULT		(BOARD_HIHOPE_RZG2M << BOARD_CODE_SHIFT)
 #endif
 #endif
+#endif
 
 #define BOARD_CODE_MASK		(0xF8)
 #define BOARD_REV_MASK		(0x07)
@@ -50,6 +62,9 @@
 #define HN_ID	{ 0x20U, 0xFFU, 0xFFU, 0xFFU, 0xFFU, 0xFFU, 0xFFU, 0xFFU }
 #define HH_ID	{ 0x10U, 0xFFU, 0xFFU, 0xFFU, 0xFFU, 0xFFU, 0xFFU, 0xFFU }
 #define EK_ID	{ 0x10U, 0xFFU, 0xFFU, 0xFFU, 0xFFU, 0xFFU, 0xFFU, 0xFFU }
+#define NB_ID	{ 0x10U, 0xFFU, 0xFFU, 0xFFU, 0xFFU, 0xFFU, 0xFFU, 0xFFU }
+#define HC_ID	{ 0x10U, 0xFFU, 0xFFU, 0xFFU, 0xFFU, 0xFFU, 0xFFU, 0xFFU }
+#define ME_ID	{ 0x10U, 0xFFU, 0xFFU, 0xFFU, 0xFFU, 0xFFU, 0xFFU, 0xFFU }
 
 const char *g_board_tbl[] = {
 	[BOARD_STARTER_KIT_PRE] = "Starter Kit Premier",
@@ -65,6 +80,9 @@ const char *g_board_tbl[] = {
 	[BOARD_HIHOPE_RZG2N]	= "HiHope RZ/G2N",
 	[BOARD_HIHOPE_RZG2H]	= "HiHope RZ/G2H",
 	[BOARD_EK874]			= "EK874 RZ/G2E",
+	[BOARD_TQMARZG2N_B]		= "TQMaRZG2N (2GB)",
+	[BOARD_TQMARZG2M_E]		= "TQMaRZG2M (8GB)",
+	[BOARD_TQMARZG2H_C]		= "TQMaRZG2H (4GB)",
 	[BOARD_UNKNOWN] = "unknown"
 };
 
@@ -85,6 +103,9 @@ int32_t rcar_get_board_type(uint32_t *type, uint32_t *rev)
 		[BOARD_HIHOPE_RZG2N] = HN_ID,
 		[BOARD_HIHOPE_RZG2H] = HH_ID,
 		[BOARD_EK874] = EK_ID,
+		[BOARD_TQMARZG2N_B]	= NB_ID,
+		[BOARD_TQMARZG2M_E]	= ME_ID,
+		[BOARD_TQMARZG2H_C]	= HC_ID,
 	};
 	static uint8_t board_id = BOARD_ID_UNKNOWN;
 #if (RZG_HIHOPE_RZG2H)
diff --git a/drivers/renesas/rzg/board/board.h b/drivers/renesas/rzg/board/board.h
index e64ba47b5..979cd914b 100644
--- a/drivers/renesas/rzg/board/board.h
+++ b/drivers/renesas/rzg/board/board.h
@@ -21,7 +21,10 @@
 #define BOARD_HIHOPE_RZG2M		(0x11U)
 #define BOARD_HIHOPE_RZG2N		(0x12U)
 #define BOARD_HIHOPE_RZG2H		(0x13U)
-#define BOARD_UNKNOWN			(BOARD_HIHOPE_RZG2H + 1U)
+#define BOARD_TQMARZG2N_B		(0x14U)
+#define BOARD_TQMARZG2M_E		(0x15U)
+#define BOARD_TQMARZG2H_C		(0x16U)
+#define BOARD_UNKNOWN			(BOARD_TQMARZG2H_C+1U)
 
 #define BOARD_REV_UNKNOWN		(0xFF)
 
diff --git a/drivers/renesas/rzg/ddr/ddr_b/boot_init_dram_config.c b/drivers/renesas/rzg/ddr/ddr_b/boot_init_dram_config.c
index b546ead7b..a9631c9c3 100644
--- a/drivers/renesas/rzg/ddr/ddr_b/boot_init_dram_config.c
+++ b/drivers/renesas/rzg/ddr/ddr_b/boot_init_dram_config.c
@@ -5,7 +5,7 @@
  * SPDX-License-Identifier: BSD-3-Clause
  */
 
-#define BOARDNUM 27
+#define BOARDNUM 30
 #define BOARD_JUDGE_AUTO
 
 #ifdef BOARD_JUDGE_AUTO
@@ -1851,12 +1851,196 @@ static const struct _boardcnf boardcnfs[BOARDNUM] = {
 	}
 	}
 },
+
+/* boardcnf[27] TQMaRZG2N 8Gbit/1Rank/2ch --> 16 Gbit total per Chip --> 16 Gbit total on */
+{
+	0x01,
+	0x01,
+	0x0300,
+	0,
+	0x0300,
+	0x00a0,
+	{
+		{
+			{0x04, 0xff},
+			 0x00543210,
+			 0x3210,
+			{0x17602534, 0x23546701, 0x43257160, 0x10765243},
+			{0x08, 0x08, 0x08, 0x08},
+			 WDQLVL_PAT,
+			{0, 0, 0, 0, 0, 0, 0, 0,
+			 0, 0},
+			{0, 0, 0, 0},
+			{0, 0, 0, 0, 0, 0, 0, 0,
+			 0, 0, 0, 0, 0, 0, 0, 0,
+			 0, 0, 0, 0, 0, 0, 0, 0,
+			 0, 0, 0, 0, 0, 0, 0, 0},
+			{0, 0, 0, 0},
+			{0, 0, 0, 0, 0, 0, 0, 0,
+			 0, 0, 0, 0, 0, 0, 0, 0,
+			 0, 0, 0, 0, 0, 0, 0, 0,
+			 0, 0, 0, 0, 0, 0, 0, 0}
+		},
+	}
+},
+
+/* boardcnf[28] TQMaRZG2M 16Gbit/2Rank/2ch --> 32 Gbit total per Chip --> 64 Gbit total on */
+{
+	0x03,
+	0x01,
+	0x2c0,
+	0,
+	0x0300,
+	0x00a0,
+	{
+		{
+			{0x04, 0x04},
+			 0x00543210,
+			 0x3210,
+			{0x17602534, 0x23546701, 0x43257160, 0x10765243},
+			{0x08, 0x08, 0x08, 0x08},
+			 WDQLVL_PAT,
+			{0, 0, 0, 0, 0, 0, 0, 0,
+			 0, 0 },
+			{0, 0, 0, 0},
+			{0, 0, 0, 0, 0, 0, 0, 0,
+			 0, 0, 0, 0, 0, 0, 0, 0,
+			 0, 0, 0, 0, 0, 0, 0, 0,
+			 0, 0, 0, 0, 0, 0, 0, 0},
+			{0, 0, 0, 0},
+			{0, 0, 0, 0, 0, 0, 0, 0,
+			 0, 0, 0, 0, 0, 0, 0, 0,
+			 0, 0, 0, 0, 0, 0, 0, 0,
+			 0, 0, 0, 0, 0, 0, 0, 0}
+		},
+		{
+			{0x04, 0x04},
+			 0x00543210,
+			 0x3210,
+			{0x17502643, 0x54236170, 0x34521607, 0x07615243},
+			{0x08, 0x08, 0x08, 0x08},
+			 WDQLVL_PAT,
+			{0, 0, 0, 0, 0, 0, 0, 0,
+			 0, 0},
+			{0, 0, 0, 0},
+			{0, 0, 0, 0, 0, 0, 0, 0,
+			 0, 0, 0, 0, 0, 0, 0, 0,
+			 0, 0, 0, 0, 0, 0, 0, 0,
+			 0, 0, 0, 0, 0, 0, 0, 0},
+			{0, 0, 0, 0},
+			{0, 0, 0, 0, 0, 0, 0, 0,
+			 0, 0, 0, 0, 0, 0, 0, 0,
+			 0, 0, 0, 0, 0, 0, 0, 0,
+			 0, 0, 0, 0, 0, 0, 0, 0}
+		}
+	}
+},
+
+/*
+ * boardcnf[29] TQMaRZG2H 8Gbit/1Rank/2ch --> 16 Gbit total per Chip --> 32 Gbit total on 
+ */
+{
+	0x05,
+	0x01,
+	0x0300,
+	0,
+	0x0300,
+	0x00a0,
+	{
+		{
+			{0x04, 0xff},
+			 0x00543210,
+			 0x3210,
+			{0x17602534, 0x23541067, 0x43257160, 0x10765243},
+			{0x08, 0x08, 0x08, 0x08},
+			 WDQLVL_PAT,
+			{0, 0, 0, 0, 0, 0, 0, 0,
+			 0, 0},
+			{0, 0, 0, 0},
+			{0, 0, 0, 0, 0, 0, 0, 0,
+			 0, 0, 0, 0, 0, 0, 0, 0,
+			 0, 0, 0, 0, 0, 0, 0, 0,
+			 0, 0, 0, 0, 0, 0, 0, 0},
+			{0, 0, 0, 0},
+			{0, 0, 0, 0, 0, 0, 0, 0,
+			 0, 0, 0, 0, 0, 0, 0, 0,
+			 0, 0, 0, 0, 0, 0, 0, 0,
+			 0, 0, 0, 0, 0, 0, 0, 0}
+		},
+		{
+			{0x04, 0xff},
+			 0x00543210,
+			 0x3210,
+			{0x17502643, 0x54236170, 0x34521607, 0x07615243},
+			{0x08, 0x08, 0x08, 0x08},
+			 WDQLVL_PAT,
+			{0, 0, 0, 0, 0, 0, 0, 0,
+			 0, 0},
+			{0, 0, 0, 0},
+			{0, 0, 0, 0, 0, 0, 0, 0,
+			 0, 0, 0, 0, 0, 0, 0, 0,
+			 0, 0, 0, 0, 0, 0, 0, 0,
+			 0, 0, 0, 0, 0, 0, 0, 0},
+			{0, 0, 0, 0},
+			{0, 0, 0, 0, 0, 0, 0, 0,
+			 0, 0, 0, 0, 0, 0, 0, 0,
+			 0, 0, 0, 0, 0, 0, 0, 0,
+			 0, 0, 0, 0, 0, 0, 0, 0}
+		},
+		{
+			{0x04, 0xff},
+			 0x00543210,
+			 0x3210,
+			{0x17502643, 0x54236170, 0x34521607, 0x07615243},
+			{0x08, 0x08, 0x08, 0x08},
+			 WDQLVL_PAT,
+			{0, 0, 0, 0, 0, 0, 0, 0,
+			 0, 0},
+			{0, 0, 0, 0},
+			{0, 0, 0, 0, 0, 0, 0, 0,
+			 0, 0, 0, 0, 0, 0, 0, 0,
+			 0, 0, 0, 0, 0, 0, 0, 0,
+			 0, 0, 0, 0, 0, 0, 0, 0},
+			{0, 0, 0, 0},
+			{0, 0, 0, 0, 0, 0, 0, 0,
+			 0, 0, 0, 0, 0, 0, 0, 0,
+			 0, 0, 0, 0, 0, 0, 0, 0,
+			 0, 0, 0, 0, 0, 0, 0, 0}
+			},
+		{ // Dummy
+			{ 0xff, 0xff},
+			0,
+			0,
+			{0, 0, 0, 0},
+			{0, 0, 0, 0},
+			 WDQLVL_PAT,
+			{0, 0, 0, 0, 0, 0, 0, 0,
+			 0, 0},
+			{0, 0, 0, 0},
+			{0, 0, 0, 0, 0, 0, 0, 0,
+			 0, 0, 0, 0, 0, 0, 0, 0,
+			 0, 0, 0, 0, 0, 0, 0, 0,
+			 0, 0, 0, 0, 0, 0, 0, 0},
+			{0, 0, 0, 0},
+			{0, 0, 0, 0, 0, 0, 0, 0,
+			 0, 0, 0, 0, 0, 0, 0, 0,
+			 0, 0, 0, 0, 0, 0, 0, 0,
+			 0, 0, 0, 0, 0, 0, 0, 0}
+		}
+	}
+}
 };
 
 void boardcnf_get_brd_clk(uint32_t brd, uint32_t *clk, uint32_t *div)
 {
 	uint32_t md;
 
+#if (RZG_TQMARZG2N_B | RZG_TQMARZG2M_E | RZG_TQMARZG2H_C)
+	*clk = 75;
+	*div = 3;
+	return;
+#endif
+
 	if ((prr_product == PRR_PRODUCT_H3) && (prr_cut == PRR_PRODUCT_10)) {
 		*clk = 50;
 		*div = 3;
@@ -2061,6 +2245,21 @@ static uint32_t _board_judge(void)
 		return (26);
 	}
 #endif
+#if (RZG_TQMARZG2N_B)
+	{
+		return (27);
+	}
+#endif
+#if (RZG_TQMARZG2M_E)
+	{
+		return (28);
+	}
+#endif
+#if (RZG_TQMARZG2H_C)
+	{
+		return (29);
+	}
+#endif
 
 #if (RCAR_GEN3_ULCB == 1)
 	/* Starter Kit */
diff --git a/plat/renesas/rzg/bl2_plat_setup.c b/plat/renesas/rzg/bl2_plat_setup.c
index bde7984b6..6e92ee47b 100644
--- a/plat/renesas/rzg/bl2_plat_setup.c
+++ b/plat/renesas/rzg/bl2_plat_setup.c
@@ -482,6 +482,12 @@ static void bl2_populate_compatible_string(void *dt)
 		ret = fdt_setprop_string(dt, 0, "compatible",
 					 "renesas,ek874");
 		break;
+	case BOARD_TQMARZG2N_B:
+	case BOARD_TQMARZG2M_E:
+	case BOARD_TQMARZG2H_C:
+		ret = fdt_setprop_string(dt, 0, "compatible",
+					 "renesas,tqmarzg2");
+		break;
 	default:
 		NOTICE("BL2: Cannot set compatible string, board unsupported\n");
 		panic();
@@ -608,7 +614,11 @@ static void bl2_advertise_dram_size(uint32_t product)
 
 	switch (product) {
 	case PRR_PRODUCT_H3:
-#if (RCAR_DRAM_LPDDR4_MEMCONF == 0)
+#if (RZG_TQMARZG2H_C)
+		/* 4GB(2GBx2 2ch split) */
+		dram_config[1] = 0x80000000ULL;
+		dram_config[3] = 0x80000000ULL;
+#elif (RCAR_DRAM_LPDDR4_MEMCONF == 0)
 		/* 4GB(1GBx4) */
 		dram_config[1] = 0x40000000ULL;
 		dram_config[3] = 0x40000000ULL;
@@ -630,7 +640,11 @@ static void bl2_advertise_dram_size(uint32_t product)
 		break;
 
 	case PRR_PRODUCT_M3:
-#if (RCAR_GEN3_ULCB == 1)
+#if (RZG_TQMARZG2M_E)
+		/* 8GB(4GBx2 2ch split) */
+		dram_config[1] = 0x100000000ULL;
+		dram_config[5] = 0x100000000ULL;
+#elif (RCAR_GEN3_ULCB == 1)
 		/* 2GB(1GBx2 2ch split) */
 		dram_config[1] = 0x40000000ULL;
 		dram_config[5] = 0x40000000ULL;
@@ -642,8 +656,13 @@ static void bl2_advertise_dram_size(uint32_t product)
 		break;
 
 	case PRR_PRODUCT_M3N:
+#if (RZG_TQMARZG2M_E)
 		/* 2GB(1GBx2) */
 		dram_config[1] = 0x80000000ULL;
+#else
+		/* 2GB(1GBx2) */
+		dram_config[1] = 0x80000000ULL;
+#endif
 		break;
 
 	case PRR_PRODUCT_V3M:
@@ -813,6 +832,9 @@ void bl2_el3_early_platform_setup(u_register_t arg1, u_register_t arg2,
 	case BOARD_HIHOPE_RZG2M:
 	case BOARD_HIHOPE_RZG2N:
 	case BOARD_EK874:
+	case BOARD_TQMARZG2N_B:
+	case BOARD_TQMARZG2M_E:
+	case BOARD_TQMARZG2H_C:
 		break;
 	default:
 		type = BOARD_UNKNOWN;
diff --git a/plat/renesas/rzg/platform.mk b/plat/renesas/rzg/platform.mk
index c14f7840b..ac597e26f 100644
--- a/plat/renesas/rzg/platform.mk
+++ b/plat/renesas/rzg/platform.mk
@@ -320,6 +320,24 @@ RZG_HIHOPE_RZG2H := 0
 endif
 $(eval $(call add_define,RZG_HIHOPE_RZG2H))
 
+#Process RZG_TQMARZG2N_B flag
+ifndef RZG_TQMARZG2N_B
+RZG_TQMARZG2N_B := 0
+endif
+$(eval $(call add_define,RZG_TQMARZG2N_B))
+
+#Process RZG_TQMARZG2M_E flag
+ifndef RZG_TQMARZG2M_E
+RZG_TQMARZG2M_E := 0
+endif
+$(eval $(call add_define,RZG_TQMARZG2M_E))
+
+#Process RZG_TQMARZG2H_C flag
+ifndef RZG_TQMARZG2H_C
+RZG_TQMARZG2H_C := 0
+endif
+$(eval $(call add_define,RZG_TQMARZG2H_C))
+
 # Enable workarounds for selected Cortex-A53 erratas.
 ERRATA_A53_835769  := 1
 ifdef ERRATA_A53_843419
-- 
2.25.1

