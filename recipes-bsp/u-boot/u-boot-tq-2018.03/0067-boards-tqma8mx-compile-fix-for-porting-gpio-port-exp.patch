From c3af0ab1cd88160a918abe37859c97e582752719 Mon Sep 17 00:00:00 2001
From: Markus Niebel <Markus.Niebel@tq-group.com>
Date: Mon, 18 Feb 2019 10:08:35 +0100
Subject: [PATCH] boards: tqma8mx: compile fix for porting gpio port expander

Signed-off-by: Markus Niebel <Markus.Niebel@tq-group.com>
---
 configs/tqma8mq_mba8mx_mmc_defconfig | 13 +++++++
 include/configs/tqma8mx-mba8mx.h     |  2 +-
 include/configs/tqma8mx.h            | 53 ++++++++++++----------------
 3 files changed, 37 insertions(+), 31 deletions(-)

diff --git a/configs/tqma8mq_mba8mx_mmc_defconfig b/configs/tqma8mq_mba8mx_mmc_defconfig
index b20c368ee5..2fd2510335 100644
--- a/configs/tqma8mq_mba8mx_mmc_defconfig
+++ b/configs/tqma8mq_mba8mx_mmc_defconfig
@@ -3,11 +3,14 @@ CONFIG_ARCH_IMX8M=y
 CONFIG_SYS_TEXT_BASE=0x40200000
 CONFIG_SYS_MALLOC_F_LEN=0x2000
 CONFIG_TARGET_TQMA8MX=y
+CONFIG_SAVED_DRAM_TIMING_BASE=0x40000000
 CONFIG_DEFAULT_DEVICE_TREE="fsl-imx8mq-tqma8mq-mba8mx"
 CONFIG_FIT=y
 CONFIG_SPL_LOAD_FIT=y
 CONFIG_SYS_EXTRA_OPTIONS="IMX_CONFIG=arch/arm/mach-imx/spl_sd.cfg"
 CONFIG_ARCH_MISC_INIT=y
+CONFIG_SPL=y
+CONFIG_SPL_BOARD_INIT=y
 CONFIG_HUSH_PARSER=y
 CONFIG_CMD_MEMINFO=y
 CONFIG_CMD_MEMTEST=y
@@ -15,13 +18,19 @@ CONFIG_CMD_GPIO=y
 CONFIG_CMD_I2C=y
 CONFIG_CMD_CACHE=y
 CONFIG_CMD_TIME=y
+CONFIG_CMD_PMIC=y
+CONFIG_CMD_REGULATOR=y
 CONFIG_CMD_UBI=y
+CONFIG_CMD_REGULATOR=y
 # CONFIG_DOS_PARTITION is not set
 CONFIG_OF_CONTROL=y
+CONFIG_ENV_IS_IN_MMC=y
 CONFIG_IMX8M_LPDDR4=y
+CONFIG_SAVED_DRAM_TIMING_BASE=0x40000000
 CONFIG_DM_GPIO=y
 CONFIG_DM_I2C=y
 CONFIG_SYS_I2C_MXC=y
+CONFIG_ENV_IS_IN_MMC=y
 CONFIG_DM_MMC=y
 CONFIG_PHYLIB=y
 CONFIG_PHY_TI=y
@@ -34,9 +43,13 @@ CONFIG_DM_REGULATOR_PFUZE100=y
 CONFIG_DM_REGULATOR_FIXED=y
 CONFIG_DM_REGULATOR_GPIO=y
 CONFIG_SYS_I2C_MXC=y
+CONFIG_CMD_PMIC=y
+CONFIG_DM_THERMAL=y
 CONFIG_NXP_TMU=y
 CONFIG_USB=y
 CONFIG_DM_USB=y
+CONFIG_USB_XHCI_HCD=y
+# CONFIG_USB_XHCI_IMX8M is not set
 CONFIG_USB_EHCI_HCD=y
 CONFIG_USB_STORAGE=y
 CONFIG_FS_EXT4=y
diff --git a/include/configs/tqma8mx-mba8mx.h b/include/configs/tqma8mx-mba8mx.h
index 54958cfac5..dc7966ba5a 100644
--- a/include/configs/tqma8mx-mba8mx.h
+++ b/include/configs/tqma8mx-mba8mx.h
@@ -8,7 +8,7 @@
 #define __TQMA8MX_MBA8MX_H
 
 #if !defined(CONFIG_SPL_BUILD)
-#define CONFIG_DM_GPIO
+/* #define CONFIG_DM_GPIO */
 #define CONFIG_DM_PCA953X
 #endif
 
diff --git a/include/configs/tqma8mx.h b/include/configs/tqma8mx.h
index 5814f4211a..a9fed59053 100644
--- a/include/configs/tqma8mx.h
+++ b/include/configs/tqma8mx.h
@@ -1,5 +1,4 @@
 /*
- * Copyright 2017 NXP
  * Copyright 2019 TQ Systems GmbH
  *
  * SPDX-License-Identifier:	GPL-2.0+
@@ -15,9 +14,8 @@
 #define CONFIG_CSF_SIZE			0x2000 /* 8K region */
 #endif
 
-/* #define CONFIG_SPL_FRAMEWORK */
 #define CONFIG_SPL_TEXT_BASE		0x7E1000
-#define CONFIG_SPL_MAX_SIZE		(124 * 1024)
+#define CONFIG_SPL_MAX_SIZE		(148 * 1024)
 #define CONFIG_SYS_MONITOR_LEN		(512 * 1024)
 #if defined(CONFIG_SD_BOOT)
 #define CONFIG_SYS_MMCSD_RAW_MODE_U_BOOT_USE_SECTOR
@@ -33,7 +31,7 @@
 #define CONFIG_SPL_DRIVERS_MISC_SUPPORT
 #define CONFIG_SPL_POWER_SUPPORT
 #define CONFIG_SPL_I2C_SUPPORT
-#define CONFIG_SPL_BOARD_INIT
+/* #define CONFIG_SPL_BOARD_INIT */
 #define CONFIG_SPL_LDSCRIPT		"arch/arm/cpu/armv8/u-boot-spl.lds"
 #define CONFIG_SPL_STACK		0x187FF0
 #define CONFIG_SPL_LIBCOMMON_SUPPORT
@@ -43,13 +41,20 @@
 #define CONFIG_SPL_MMC_SUPPORT
 #define CONFIG_SPL_BSS_START_ADDR      0x00180000
 #define CONFIG_SPL_BSS_MAX_SIZE        0x2000	/* 8 KB */
-#define CONFIG_SYS_SPL_MALLOC_START    0x00182000
-#define CONFIG_SYS_SPL_MALLOC_SIZE     0x2000	/* 8 KB */
+#define CONFIG_SYS_SPL_MALLOC_START    0x42200000
+#define CONFIG_SYS_SPL_MALLOC_SIZE    0x80000	/* 512 KB */
+#define CONFIG_SYS_SPL_PTE_RAM_BASE    0x41580000
 #define CONFIG_SYS_ICACHE_OFF
 #define CONFIG_SYS_DCACHE_OFF
 
+#define CONFIG_MALLOC_F_ADDR		0x182000 /* malloc f used before GD_FLG_FULL_MALLOC_INIT set */
+
 #define CONFIG_SPL_ABORT_ON_RAW_IMAGE /* For RAW image gives a error info not panic */
 
+#undef CONFIG_DM_MMC
+#undef CONFIG_DM_PMIC
+#undef CONFIG_DM_PMIC_PFUZE100
+
 #define CONFIG_SYS_I2C
 #define CONFIG_SYS_I2C_SPEED		100000
 #define CONFIG_SYS_I2C_MXC_I2C1		/* enable I2C bus 1 */
@@ -71,6 +76,7 @@
  * - gpio expander support via dt
  * - i2c eeprom support via dt
  */
+#if 0
 #define CONFIG_CMD_PMIC
 #define CONFIG_CMD_REGULATOR
 
@@ -85,6 +91,7 @@
 #define CONFIG_DM_REGULATOR_PFUZE100
 #define CONFIG_DM_REGULATOR_FIXED
 #define CONFIG_DM_REGULATOR_GPIO
+#endif
 #define CONFIG_I2C_EEPROM
 
 #endif
@@ -184,7 +191,7 @@
 
 /* Link Definitions */
 #define CONFIG_LOADADDR			0x40480000
-#define CONFIG_SYS_TEXT_BASE		0x40200000
+/* #define CONFIG_SYS_TEXT_BASE		0x40200000 */
 
 #define CONFIG_SYS_LOAD_ADDR           CONFIG_LOADADDR
 
@@ -200,7 +207,6 @@
 #if defined(CONFIG_SD_BOOT)
 #define CONFIG_ENV_OFFSET		(64 * SZ_64K)
 #define CONFIG_ENV_SIZE			0x1000
-#define CONFIG_ENV_IS_IN_MMC
 #define CONFIG_SYS_MMC_ENV_DEV		1   /* USDHC2 */
 #elif defined(CONFIG_QSPI_BOOT)
 #error
@@ -230,15 +236,12 @@
 /* Monitor Command Prompt */
 #undef CONFIG_SYS_PROMPT
 #define CONFIG_SYS_PROMPT		"u-boot=> "
-/* #define CONFIG_SYS_LONGHELP */
 #define CONFIG_SYS_PROMPT_HUSH_PS2     "> "
-/* #define CONFIG_AUTO_COMPLETE */
 #define CONFIG_SYS_CBSIZE              2048
 #define CONFIG_SYS_MAXARGS             64
 #define CONFIG_SYS_BARGSIZE CONFIG_SYS_CBSIZE
 #define CONFIG_SYS_PBSIZE		(CONFIG_SYS_CBSIZE + \
 					sizeof(CONFIG_SYS_PROMPT) + 16)
-/* #define CONFIG_CMDLINE_EDITING */
 
 #define CONFIG_IMX_BOOTAUX
 
@@ -249,12 +252,6 @@
 #define CONFIG_SYS_FSL_USDHC_NUM	2
 #define CONFIG_SYS_FSL_ESDHC_ADDR       0
 
-#define CONFIG_DOS_PARTITION
-#define CONFIG_CMD_EXT2
-#define CONFIG_CMD_EXT4
-#define CONFIG_CMD_EXT4_WRITE
-#define CONFIG_CMD_FAT
-
 #define CONFIG_SUPPORT_EMMC_BOOT	/* eMMC specific */
 #define CONFIG_SYS_MMC_IMG_LOAD_PART	1
 
@@ -289,26 +286,22 @@
 
 /* USB configs */
 #ifndef CONFIG_SPL_BUILD
-#define CONFIG_HAS_FSL_XHCI_USB
-
-#ifdef CONFIG_HAS_FSL_XHCI_USB
-#define CONFIG_USB_XHCI_IMX8M
-#define CONFIG_USB_XHCI_DWC3
-#define CONFIG_USB_XHCI_HCD
-#define CONFIG_USB_MAX_CONTROLLER_COUNT         2
-/* #define CONFIG_SYS_USB_XHCI_MAX_ROOT_PORTS      2 */
-#endif
 
 #define CONFIG_CMD_USB
 /* #define CONFIG_USB_STORAGE */
-#define CONFIG_CMD_EXT2
 
-#define CONFIG_USB_DWC3
-#define CONFIG_USB_DWC3_GADGET
-#define CONFIG_USBD_HS
+/* #define CONFIG_CMD_USB_MASS_STORAGE */
+
+#define CONFIG_CMD_READ
 
 #endif
 
+#define CONFIG_CMD_EXT2
+#define CONFIG_USB_MAX_CONTROLLER_COUNT         2
+/* #define CONFIG_SYS_USB_XHCI_MAX_ROOT_PORTS      2 */
+
+#define CONFIG_USBD_HS
+
 #define CONFIG_OF_SYSTEM_SETUP
 
 #if defined(CONFIG_MBA8MX)
