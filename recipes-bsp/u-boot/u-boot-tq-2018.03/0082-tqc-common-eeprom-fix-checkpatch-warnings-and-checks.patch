From 7db13b6f8c231efc579c4cddd922ad8564e32d6a Mon Sep 17 00:00:00 2001
From: Markus Niebel <Markus.Niebel@tq-group.com>
Date: Thu, 24 Jan 2019 14:47:57 +0100
Subject: [PATCH] tqc: common: eeprom: fix checkpatch warnings and checks

port from 4ce853f717eb0a0b9e3cac53943c53372eb677cc

Signed-off-by: Max Merchel <Max.Merchel@tq-group.com>
Signed-off-by: Markus Niebel <Markus.Niebel@tq-group.com>
---
 board/tqc/common/tqc_eeprom.c | 41 ++++++++++++++++++++++++-----------
 board/tqc/common/tqc_eeprom.h |  2 +-
 2 files changed, 29 insertions(+), 14 deletions(-)

diff --git a/board/tqc/common/tqc_eeprom.c b/board/tqc/common/tqc_eeprom.c
index 6523c2c9d1..b9e34439f5 100644
--- a/board/tqc/common/tqc_eeprom.c
+++ b/board/tqc/common/tqc_eeprom.c
@@ -2,7 +2,7 @@
  * Copyright (C) 2014 - 2016 TQ Systems GmbH
  * Markus Niebel <Markus.Niebel@tq-group.com>
  *
- * SPDX-License-Identifier:	GPL-2.0+
+ * SPDX-License-Identifier:    GPL-2.0+
  */
 
 #include <common.h>
@@ -29,13 +29,13 @@ int tqc_parse_eeprom_mac(struct tqc_eeprom_data *eeprom, char *buf,
 	if (ret >= len)
 		return ret;
 
-	return 0;
+	return !(is_valid_ethaddr(p));
 }
 
 int tqc_parse_eeprom_serial(struct tqc_eeprom_data *eeprom, char *buf,
 			    size_t len)
 {
-	unsigned i;
+	unsigned int i;
 
 	if (!buf || !eeprom)
 		return -1;
@@ -43,7 +43,7 @@ int tqc_parse_eeprom_serial(struct tqc_eeprom_data *eeprom, char *buf,
 		return -1;
 
 	for (i = 0; i < (sizeof(eeprom->serial)) &&
-		isdigit(eeprom->serial[i]); i++)
+	     isdigit(eeprom->serial[i]); i++)
 		buf[i] = eeprom->serial[i];
 	buf[i] = '\0';
 	if (sizeof(eeprom->serial) != strlen(buf))
@@ -55,15 +55,15 @@ int tqc_parse_eeprom_serial(struct tqc_eeprom_data *eeprom, char *buf,
 int tqc_parse_eeprom_id(struct tqc_eeprom_data *eeprom, char *buf,
 			size_t len)
 {
-	unsigned i;
+	unsigned int i;
 
 	if (!buf || !eeprom)
 		return -1;
 	if (len < (sizeof(eeprom->id) + 1))
 		return -1;
 
-	for (i = 0; i < sizeof(eeprom->id) &&
-		isprint(eeprom->id[i]) && isascii(eeprom->id[i]); ++i)
+	for (i = 0; i < sizeof(eeprom->id) && isprint(eeprom->id[i]) &&
+	     isascii(eeprom->id[i]); ++i)
 		buf[i] = eeprom->id[i];
 	buf[i] = '\0';
 
@@ -86,20 +86,20 @@ int tqc_show_eeprom(struct tqc_eeprom_data *eeprom, const char *id)
 	/* ID */
 	tqc_parse_eeprom_id(eeprom, safe_string,
 			      ARRAY_SIZE(safe_string));
-	if (0 == strncmp(safe_string, id, strlen(id)))
+	if (strncmp(safe_string, id, strlen(id)) == 0)
 		printf("  ID: %s\n", safe_string);
 	else
 		puts("  unknown hardware variant\n");
 
 	/* Serial number */
-	if (0 == tqc_parse_eeprom_serial(eeprom, safe_string,
-					   ARRAY_SIZE(safe_string)))
+	if (tqc_parse_eeprom_serial(eeprom, safe_string,
+				    ARRAY_SIZE(safe_string)) == 0)
 		printf("  SN: %s\n", safe_string);
 	else
 		puts("  unknown serial number\n");
 	/* MAC address */
-	if (0 == tqc_parse_eeprom_mac(eeprom, safe_string,
-					ARRAY_SIZE(safe_string)))
+	if (tqc_parse_eeprom_mac(eeprom, safe_string,
+				 ARRAY_SIZE(safe_string)) == 0)
 		printf("  MAC: %s\n", safe_string);
 	else
 		puts("  invalid MAC\n");
@@ -114,15 +114,30 @@ int tqc_read_eeprom(unsigned int bus, unsigned int addr,
 		    struct tqc_eeprom_data *eeprom)
 {
 	int ret;
+#ifdef CONFIG_DM_I2C
+	struct udevice *dev;
+#else
 	unsigned int oldbus;
+#endif
+
 	if (!eeprom)
 		return -1;
 
+#ifdef CONFIG_DM_I2C
+	ret = i2c_get_chip_for_busnum(bus, addr, CONFIG_SYS_I2C_EEPROM_ADDR_LEN,
+				      &dev);
+	if (ret) {
+		debug("%s: Cannot find I2C chip for bus %d\n", __func__, bus);
+		return ret;
+	}
+
+	ret = dm_i2c_read(dev, 0, (uchar *)eeprom, sizeof(*eeprom));
+#else
 	oldbus = i2c_get_bus_num();
 	i2c_set_bus_num(bus);
 	ret = i2c_read(addr, 0, CONFIG_SYS_I2C_EEPROM_ADDR_LEN,
 		       (uchar *)eeprom, sizeof(*eeprom));
 	i2c_set_bus_num(oldbus);
+#endif
 	return ret;
 }
-
diff --git a/board/tqc/common/tqc_eeprom.h b/board/tqc/common/tqc_eeprom.h
index 6c1b06f7a5..119456ec62 100644
--- a/board/tqc/common/tqc_eeprom.h
+++ b/board/tqc/common/tqc_eeprom.h
@@ -2,7 +2,7 @@
  * Copyright (C) 2014 - 2016 TQ Systems GmbH
  * Markus Niebel <Markus.Niebel@tq-group.com>
  *
- * SPDX-License-Identifier:	GPL-2.0+
+ * SPDX-License-Identifier:    GPL-2.0+
  */
 
 #ifndef __TQC_EEPROM_H__
