From 5d91810fbf64b71ad6431a01c1104a5ecb67897e Mon Sep 17 00:00:00 2001
From: Markus Niebel <Markus.Niebel@tq-group.com>
Date: Mon, 18 Feb 2019 14:31:16 +0100
Subject: [PATCH] board: tqma8mq: allow two different lpddr4 timings

Signed-off-by: Markus Niebel <Markus.Niebel@tq-group.com>
---
 board/tqc/tqma8mx/Makefile            |  2 +-
 board/tqc/tqma8mx/lpddr4_timing_2gm.c | 16 ++++++++--------
 board/tqc/tqma8mx/lpddr4_timing_2gs.c | 18 +++++++++---------
 board/tqc/tqma8mx/spl.c               |  5 ++++-
 4 files changed, 22 insertions(+), 19 deletions(-)

diff --git a/board/tqc/tqma8mx/Makefile b/board/tqc/tqma8mx/Makefile
index 15ac5e4e39..be329c82d1 100644
--- a/board/tqc/tqma8mx/Makefile
+++ b/board/tqc/tqma8mx/Makefile
@@ -11,5 +11,5 @@ obj-$(CONFIG_MBA8MX) += tqma8mx-mba8mx.o
 ifdef CONFIG_SPL_BUILD
 obj-y += spl.o
 obj-y += lpddr4_timing_2gs.o
-### /* obj-y += lpddr4_timing_2gm.o */
+obj-y += lpddr4_timing_2gm.o
 endif
diff --git a/board/tqc/tqma8mx/lpddr4_timing_2gm.c b/board/tqc/tqma8mx/lpddr4_timing_2gm.c
index d1b0100f88..144639d7e6 100644
--- a/board/tqc/tqma8mx/lpddr4_timing_2gm.c
+++ b/board/tqc/tqma8mx/lpddr4_timing_2gm.c
@@ -10,7 +10,7 @@
 #include <linux/kernel.h>
 #include <asm/arch/imx8m_ddr.h>
 
-struct dram_cfg_param ddr_ddrc_cfg[] = {
+static struct dram_cfg_param ddr_ddrc_cfg[] = {
 	/** Initialize DDRC registers **/
 	{0x3d400304,0x1},
 	{0x3d400030,0x1},
@@ -102,7 +102,7 @@ struct dram_cfg_param ddr_ddrc_cfg[] = {
 };
 
 /* PHY Initialize Configuration */
-struct dram_cfg_param ddr_ddrphy_cfg[] = {
+static struct dram_cfg_param ddr_ddrphy_cfg[] = {
 	{0x100a0,0x1},
 	{0x100a1,0x0},
 	{0x100a2,0x2},
@@ -267,7 +267,7 @@ struct dram_cfg_param ddr_ddrphy_cfg[] = {
 };
 
 /* ddr phy trained csr */
-struct dram_cfg_param ddr_ddrphy_trained_csr[] = {
+static struct dram_cfg_param ddr_ddrphy_trained_csr[] = {
 	{ 0x200b2, 0x0 },  
 	{ 0x1200b2, 0x0 },
 	{ 0x2200b2, 0x0 },
@@ -989,7 +989,7 @@ struct dram_cfg_param ddr_ddrphy_trained_csr[] = {
 	{ 0x13830, 0x0 },
 };
 /* P0 message block paremeter for training firmware */
-struct dram_cfg_param ddr_fsp0_cfg[] = {
+static struct dram_cfg_param ddr_fsp0_cfg[] = {
 	{0xd0000, 0x0},
 	{0x54003,0xc80},
 	{0x54004,0x2},
@@ -1029,7 +1029,7 @@ struct dram_cfg_param ddr_fsp0_cfg[] = {
 
 
 /* P1 message block paremeter for training firmware */
-struct dram_cfg_param ddr_fsp1_cfg[] = {
+static struct dram_cfg_param ddr_fsp1_cfg[] = {
 	{0xd0000, 0x0},
 	{0x54002,0x1},
 	{0x54003,0x29c},
@@ -1070,7 +1070,7 @@ struct dram_cfg_param ddr_fsp1_cfg[] = {
 
 
 /* P0 2D message block paremeter for training firmware */
-struct dram_cfg_param ddr_fsp0_2d_cfg[] = {
+static struct dram_cfg_param ddr_fsp0_2d_cfg[] = {
 	{0xd0000, 0x0},
 	{0x54003,0xc80},
 	{0x54004,0x2},
@@ -1693,7 +1693,7 @@ struct dram_cfg_param ddr_phy_pie[] = {
 	{0xd0000, 0x1}
 };
 
-struct dram_fsp_msg ddr_dram_fsp_msg[] = {
+static struct dram_fsp_msg ddr_dram_fsp_msg[] = {
 	{
 		/* P0 3200mts 1D */
 		.drate = 3200,
@@ -1718,7 +1718,7 @@ struct dram_fsp_msg ddr_dram_fsp_msg[] = {
 };
 
 /* ddr timing config params */
-struct dram_timing_info dram_timing = {
+struct dram_timing_info dram_timing_2gm = {
 	.ddrc_cfg = ddr_ddrc_cfg,
 	.ddrc_cfg_num = ARRAY_SIZE(ddr_ddrc_cfg),
 	.ddrphy_cfg = ddr_ddrphy_cfg,
diff --git a/board/tqc/tqma8mx/lpddr4_timing_2gs.c b/board/tqc/tqma8mx/lpddr4_timing_2gs.c
index e5bd553025..837c7fc39a 100644
--- a/board/tqc/tqma8mx/lpddr4_timing_2gs.c
+++ b/board/tqc/tqma8mx/lpddr4_timing_2gs.c
@@ -10,7 +10,7 @@
 #include <linux/kernel.h>
 #include <asm/arch/imx8m_ddr.h>
 
-struct dram_cfg_param ddr_ddrc_cfg[] = {
+static struct dram_cfg_param ddr_ddrc_cfg[] = {
 	/** Initialize DDRC registers **/
 	{0x3d400304,0x1},
 	{0x3d400030,0x1},
@@ -102,7 +102,7 @@ struct dram_cfg_param ddr_ddrc_cfg[] = {
 };
 
 /* PHY Initialize Configuration */
-struct dram_cfg_param ddr_ddrphy_cfg[] = {
+static struct dram_cfg_param ddr_ddrphy_cfg[] = {
 	{0x100a0,0x1},
 	{0x100a1,0x0},
 	{0x100a2,0x2},
@@ -267,7 +267,7 @@ struct dram_cfg_param ddr_ddrphy_cfg[] = {
 };
 
 /* ddr phy trained csr */
-struct dram_cfg_param ddr_ddrphy_trained_csr[] = {
+static struct dram_cfg_param ddr_ddrphy_trained_csr[] = {
 	{ 0x200b2, 0x0 },  
 	{ 0x1200b2, 0x0 },
 	{ 0x2200b2, 0x0 },
@@ -989,7 +989,7 @@ struct dram_cfg_param ddr_ddrphy_trained_csr[] = {
 	{ 0x13830, 0x0 },
 };
 /* P0 message block paremeter for training firmware */
-struct dram_cfg_param ddr_fsp0_cfg[] = {
+static struct dram_cfg_param ddr_fsp0_cfg[] = {
 	{0xd0000, 0x0},
 	{0x54003,0xc80},
 	{0x54004,0x2},
@@ -1029,7 +1029,7 @@ struct dram_cfg_param ddr_fsp0_cfg[] = {
 
 
 /* P1 message block paremeter for training firmware */
-struct dram_cfg_param ddr_fsp1_cfg[] = {
+static struct dram_cfg_param ddr_fsp1_cfg[] = {
 	{0xd0000, 0x0},
 	{0x54002,0x1},
 	{0x54003,0x29c},
@@ -1070,7 +1070,7 @@ struct dram_cfg_param ddr_fsp1_cfg[] = {
 
 
 /* P0 2D message block paremeter for training firmware */
-struct dram_cfg_param ddr_fsp0_2d_cfg[] = {
+static struct dram_cfg_param ddr_fsp0_2d_cfg[] = {
 	{0xd0000, 0x0},
 	{0x54003,0xc80},
 	{0x54004,0x2},
@@ -1110,7 +1110,7 @@ struct dram_cfg_param ddr_fsp0_2d_cfg[] = {
 };
 
 /* DRAM PHY init engine image */
-struct dram_cfg_param ddr_phy_pie[] = {
+static struct dram_cfg_param ddr_phy_pie[] = {
 	{0xd0000, 0x0},
 	{0x90000,0x10},
 	{0x90001,0x400},
@@ -1693,7 +1693,7 @@ struct dram_cfg_param ddr_phy_pie[] = {
 	{0xd0000, 0x1}
 };
 
-struct dram_fsp_msg ddr_dram_fsp_msg[] = {
+static struct dram_fsp_msg ddr_dram_fsp_msg[] = {
 	{
 		/* P0 3200mts 1D */
 		.drate = 3200,
@@ -1718,7 +1718,7 @@ struct dram_fsp_msg ddr_dram_fsp_msg[] = {
 };
 
 /* ddr timing config params */
-struct dram_timing_info dram_timing = {
+struct dram_timing_info dram_timing_2gs = {
 	.ddrc_cfg = ddr_ddrc_cfg,
 	.ddrc_cfg_num = ARRAY_SIZE(ddr_ddrc_cfg),
 	.ddrphy_cfg = ddr_ddrphy_cfg,
diff --git a/board/tqc/tqma8mx/spl.c b/board/tqc/tqma8mx/spl.c
index de87d61a2f..8ad5530c99 100644
--- a/board/tqc/tqma8mx/spl.c
+++ b/board/tqc/tqma8mx/spl.c
@@ -25,6 +25,9 @@
 
 DECLARE_GLOBAL_DATA_PTR;
 
+extern struct dram_timing_info dram_timing_2gs;
+extern struct dram_timing_info dram_timing_2gm;
+
 void spl_dram_init(void)
 {
 	u32 rev = get_cpu_rev() & 0xfff;
@@ -35,7 +38,7 @@ void spl_dram_init(void)
 		printf("SPL: no timing for this chip rev\n");
 		hang();
 	} else {
-		ddr_init(&dram_timing);
+		ddr_init(&dram_timing_2gs);
 	}
 }
 
