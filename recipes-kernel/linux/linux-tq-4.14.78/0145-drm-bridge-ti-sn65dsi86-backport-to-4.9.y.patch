From 773f7d02745ed2be39c7e407dff0916fb348878c Mon Sep 17 00:00:00 2001
From: Markus Niebel <Markus.Niebel@tq-group.com>
Date: Tue, 30 Oct 2018 14:20:01 +0100
Subject: [PATCH 145/188] drm/bridge: ti-sn65dsi86: backport to 4.9.y

use some older functions to pars of graph

Signed-off-by: Markus Niebel <Markus.Niebel@tq-group.com>
---
 drivers/gpu/drm/bridge/ti-sn65dsi86.c | 42 ++++++++++++++++++++++++---
 1 file changed, 38 insertions(+), 4 deletions(-)

diff --git a/drivers/gpu/drm/bridge/ti-sn65dsi86.c b/drivers/gpu/drm/bridge/ti-sn65dsi86.c
index 5b93ef518861..107d49caf2ef 100644
--- a/drivers/gpu/drm/bridge/ti-sn65dsi86.c
+++ b/drivers/gpu/drm/bridge/ti-sn65dsi86.c
@@ -530,14 +530,28 @@ static const struct drm_bridge_funcs ti_sn_bridge_funcs = {
 static int ti_sn_bridge_parse_dsi_host(struct ti_sn_bridge *pdata)
 {
 	struct device_node *np = pdata->dev->of_node;
-
+	struct device_node *ep;
+
+#if 1
+	/* port@0 is the output port */
+	ep = of_graph_get_endpoint_by_regs(np, 0, -1);
+	if (ep) {
+		pdata->host_node = of_graph_get_remote_port_parent(ep);
+		of_node_put(ep);
+
+		if (!pdata->host_node) {
+			DRM_ERROR("remote dsi host node not found\n");
+			return -ENODEV;
+		}
+	}
+#else
 	pdata->host_node = of_graph_get_remote_node(np, 0, 0);
 
 	if (!pdata->host_node) {
 		DRM_ERROR("remote dsi host node not found\n");
 		return -ENODEV;
 	}
-
+#endif
 	return 0;
 }
 
@@ -545,6 +559,7 @@ static int ti_sn_bridge_probe(struct i2c_client *client,
 			      const struct i2c_device_id *id)
 {
 	struct ti_sn_bridge *pdata;
+	struct device_node *ep;
 	int ret;
 
 	if (!i2c_check_functionality(client->adapter, I2C_FUNC_I2C)) {
@@ -565,14 +580,33 @@ static int ti_sn_bridge_probe(struct i2c_client *client,
 	}
 
 	pdata->dev = &client->dev;
-
+#if 1
+	/* port@1 is the output port */
+	ep = of_graph_get_endpoint_by_regs(pdata->dev->of_node, 1, -1);
+	if (ep) {
+		struct device_node *remote;
+
+		remote = of_graph_get_remote_port_parent(ep);
+		of_node_put(ep);
+		if (remote)
+			pdata->panel = of_drm_find_panel(remote);
+		else
+			return -EPROBE_DEFER;
+		of_node_put(remote);
+
+		if (!pdata->panel) {
+			DRM_ERROR("panel not found: %s\n", remote->full_name);
+			return -EPROBE_DEFER;
+		}
+	}
+#else
 	ret = drm_of_find_panel_or_bridge(pdata->dev->of_node, 1, 0,
 					  &pdata->panel, NULL);
 	if (ret) {
 		DRM_ERROR("could not find any panel node\n");
 		return ret;
 	}
-
+#endif
 	dev_set_drvdata(&client->dev, pdata);
 
 	pdata->enable_gpio = devm_gpiod_get(pdata->dev, "enable",
