From 494827763997f4f4f86a481adf7ddd3f71c3fe03 Mon Sep 17 00:00:00 2001
From: Markus Niebel <Markus.Niebel@tq-group.com>
Date: Mon, 10 Sep 2018 11:12:15 +0200
Subject: [PATCH 024/188] net: phy: microchip: add LAN8820 support

Signed-off-by: Markus Niebel <Markus.Niebel@tq-group.com>
---
 drivers/net/phy/microchip.c  | 60 ++++++++++++++++++++++++++++++++++++
 include/linux/microchipphy.h |  8 +++++
 2 files changed, 68 insertions(+)

diff --git a/drivers/net/phy/microchip.c b/drivers/net/phy/microchip.c
index 37ee856c7680..d4f5289b6dfd 100644
--- a/drivers/net/phy/microchip.c
+++ b/drivers/net/phy/microchip.c
@@ -30,6 +30,46 @@ struct lan88xx_priv {
 	__u32	wolopts;
 };
 
+static int lan8820_config_init(struct phy_device *phydev)
+{
+	int temp;
+	int err;
+
+	err = genphy_config_init(phydev);
+	if (err)
+		return err;
+
+	if (phy_interface_is_rgmii(phydev)) {
+		temp = phy_read(phydev, LAN8820_PHY_CSIR);
+		if (temp < 0)
+			return temp;
+
+		switch (phydev->interface) {
+		case PHY_INTERFACE_MODE_RGMII_ID:
+			temp |= (LAN8820_PHY_CSIR_TXDELAY |
+				 LAN8820_PHY_CSIR_RXDELAY);
+			break;
+		case PHY_INTERFACE_MODE_RGMII_RXID:
+			temp &= ~LAN8820_PHY_CSIR_TXDELAY;
+			temp |= LAN8820_PHY_CSIR_RXDELAY;
+			break;
+		case PHY_INTERFACE_MODE_RGMII_TXID:
+			temp &= ~LAN8820_PHY_CSIR_RXDELAY;
+			temp |= LAN8820_PHY_CSIR_TXDELAY;
+			break;
+		default:
+			temp &= ~(LAN8820_PHY_CSIR_RXDELAY |
+				  LAN8820_PHY_CSIR_RXDELAY);
+		};
+
+		err = phy_write(phydev, LAN8820_PHY_CSIR, temp);
+		if (err < 0)
+			return err;
+	}
+
+	return 0;
+}
+
 static int lan88xx_phy_config_intr(struct phy_device *phydev)
 {
 	int rc;
@@ -141,6 +181,25 @@ static int lan88xx_config_aneg(struct phy_device *phydev)
 
 static struct phy_driver microchip_phy_driver[] = {
 {
+	.phy_id		= 0x0007c0e0,
+	.phy_id_mask	= 0xfffffff0,
+	.name		= "Microchip LAN8820",
+
+	.features	= (PHY_GBIT_FEATURES |
+			   SUPPORTED_Pause | SUPPORTED_Asym_Pause),
+	.flags		= 0,
+
+	.probe		= lan88xx_probe,
+	.remove		= lan88xx_remove,
+
+	.config_init	= lan8820_config_init,
+	.config_aneg	= genphy_config_aneg,
+	.read_status	= genphy_read_status,
+
+	.suspend	= lan88xx_suspend,
+	.resume		= genphy_resume,
+	.set_wol	= lan88xx_set_wol,
+},{
 	.phy_id		= 0x0007c130,
 	.phy_id_mask	= 0xfffffff0,
 	.name		= "Microchip LAN88xx",
@@ -166,6 +225,7 @@ static struct phy_driver microchip_phy_driver[] = {
 module_phy_driver(microchip_phy_driver);
 
 static struct mdio_device_id __maybe_unused microchip_tbl[] = {
+	{ 0x0007c0e0, 0xfffffff0 },
 	{ 0x0007c130, 0xfffffff0 },
 	{ }
 };
diff --git a/include/linux/microchipphy.h b/include/linux/microchipphy.h
index eb492d47f717..027c9d553c9b 100644
--- a/include/linux/microchipphy.h
+++ b/include/linux/microchipphy.h
@@ -18,6 +18,14 @@
 #ifndef _MICROCHIPPHY_H
 #define _MICROCHIPPHY_H
 
+/* LAN8820 control / status indications reg */
+#define LAN8820_PHY_CSIR		0x1b
+#define LAN8820_PHY_CSIR_TXDELAY	0x0200
+#define LAN8820_PHY_CSIR_RXDELAY	0x0100
+
+#define LAN8820_INT_MASK		(0x1e)
+#define LAN8820_INT_STS			(0x1d)
+
 #define LAN88XX_INT_MASK			(0x19)
 #define LAN88XX_INT_MASK_MDINTPIN_EN_		(0x8000)
 #define LAN88XX_INT_MASK_SPEED_CHANGE_		(0x4000)
